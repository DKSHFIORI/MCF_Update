const __attachmentTable="idItemsUploadSet";sap.ui.define(["sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/Core","sap/m/BusyDialog","sap/ui/core/library","sap/m/library","sap/m/UploadCollectionParameter","sap/ui/core/Item","sap/m/MessageBox"],(function(e,t,a,i,n,o,s,l,r,d){"use strict";var c=o.MessageType;s.ListMode;return{onInit:function(){this._oBusyDialog=new n,this._MessageManager=i.getMessageManager();const e=new t({items:[],attachments:[]});this.getView().setModel(e,"localModel")},onSelectedChangeType:function(e){let t=e.getParameter("value"),a=this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idChangePanel::Section"),i=this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idCCDChangePanel::Section");"Finance Related"==t?(a.setVisible(!0),i.setVisible(!1)):(a.setVisible(!1),i.setVisible(!0))},onSelectedCountryType:function(e){},beforeSaveExtension:function(){},onExit:function(){},onAfterRendering:function(){var e=this;let t=this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idMaterialInput::Country::Field");sap.ui.getCore().byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idMaterialInput::ChangeType::Field").attachChange(e.onSelectedChangeType,e),t.attachChange(e.onSelectedCountryType,e),this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idChangePanel::Section").setVisible(!1),this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idCCDChangePanel::Section").setVisible(!1),this.extensionAPI.getTransactionController().attachAfterSave(e.onAfterSave.bind(this))},onAfterSave:function(){var e=this;e.getView().getModel().attachEventOnce("batchRequestCompleted",(function(t){e._checkBatchRequestSuccess(t)?e.onStartUpload():console.error("Save failed, skipping attachment upload")}))},_checkBatchRequestSuccess:function(e){var t=e.getParameter("requests"),a=!0;return t.forEach((function(e){e.success||(a=!1)})),a},onStartUpload:function(){this.getView().getModel("localModel").getProperty("/attachments").forEach((e=>{this._uploadFileToOData(e)})),e.show("Files are being uploaded.")},onUploadCompleted:function(){this.getView().getModel().refresh()},tryUpload:function(){this.onStartUpload()},_uploadFileToOData:function(e){var t=this;let a=this.byId("fileUploader");this.getView().getModel();const i=this.getView().getModel("localModel"),n=i.getProperty("/attachments")||[];var o=this.getView().getBindingContext().getObject().Product;if(0!==n.length){var s=this.getView().getModel().getSecurityToken();n.forEach((e=>{s=t.getView().getModel().getSecurityToken();let i=new sap.ui.unified.FileUploaderParameter;i.setName("x-csrf-token"),i.setValue(s);let n=new sap.ui.unified.FileUploaderParameter;n.setName("slug"),n.setValue(encodeURIComponent(e.Filename));let l=new sap.ui.unified.FileUploaderParameter;l.setName("Material"),l.setValue(o),a.setUploadUrl("/sap/opu/odata/sap/YGW_MM_MCF_UPDATE_SRV/UploadFileSet"),a.checkFileReadable().then((function(){a.addHeaderParameter(i),a.addHeaderParameter(n),a.addHeaderParameter(l),a.upload(),a.destroyHeaderParameters()}),(function(e){d.error("The file cannot be read. It may have changed."),this._oBusyDialog.close()})).then((function(e){a.clear()}))})),i.setProperty("/attachments",[]),i.updateBindings()}else sap.m.MessageToast.show("No attachments to upload.")},_base64ToBlob:function(e,t){const a=atob(e),i=[];for(let e=0;e<a.length;e+=512){const t=a.slice(e,e+512),n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);const o=new Uint8Array(n);i.push(o)}return new Blob(i,{type:t})},onAfterItemAdded:function(e){this.getView().getModel();const t=e.getParameter("item"),a=this.getView().getModel("localModel");a||(a=new sap.ui.model.json.JSONModel({items:[]}),this.getView().setModel(a,"localModel"));a.getProperty("/items");const i=this.byId("idItemsUploadSet");i.setUploadUrl("/sap/opu/odata/sap/YGW_MM_MCF_UPDATE_SRV/UploadFileSet");var n=this.getView().getModel().getSecurityToken();i.addHeaderField(new r({key:"X-CSRF-Token",text:n})),i.addHeaderField(new r({key:"Slug",text:encodeURIComponent(t.getFileName())})),i.addHeaderField(new r({key:"Content-Type",text:t.getMediaType()})),i.uploadItem(t)},onBeforeUploadStarts:function(){},onUploadSelectedButton:function(){this.onStartUpload()},onDownloadSelectedButton:function(){this.byId("UploadSet").getItems().forEach((function(e){e.getListItem().getSelected()&&e.download(!0)}))},onChange:function(t){var a=t.getSource(),i=that.getView().getBindingContext().getObject().Product;this.csrfToken=this.getView().getModel().getSecurityToken();let n=new l({name:"x-csrf-token",value:this.csrfToken}),o=new l({name:"Material",value:i});a.addHeaderParameter(n),a.addHeaderParameter(o),e.show("Event change triggered")},fileSizeExceed:function(){sap.m.MessageToast.show("Maximum permitted file size exceeded. Maximum limit : 20MB")},onFileChange:function(t){let a=t.getSource().oFileUpload.files,i=this;a.length>0?(i.selectedFiles=Array.from(a),e.show(i.selectedFiles.length+" files selected.")):e.show("No files selected.")},handleUploadPress:function(){var e=this.byId("fileUploader").getDomRef().querySelector('input[type="file"]'),t=e?e.files[0]:null;if(t){var a=new FileReader;a.onload=function(e){var t=e.target.result.split(",")[1];let a=this.byId("fileUploader").getDomRef().querySelector('input[type="file"]').files[0],i={Filename:a.name,Mimetype:a.type,Content:t},n=this.getView().getModel("localModel");n.getProperty("/attachments").push(i),n.updateBindings(),this.byId("fileUploader").clear()}.bind(this),a.readAsDataURL(t)}},deleteAttachments:function(e){let t=e.getParameter("listItem").getBindingContext("localModel").getPath().split("/")[2],a=this.getView().getModel("localModel");a.getProperty("/attachments").splice(t,1),a.updateBindings()},extractErrorMessage:function(e){return(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("errordetail")},handleUploadComplete:function(e){let t=e.mParameters.responseRaw,a=this.extractErrorMessage(t);if(this.getView().getModel().refresh(),a.length>0)for(var i=0;i<a.length;i++){let e,t=a[i].getElementsByTagName("message"),n=a[i].getElementsByTagName("severity");if("Exception raised without specific error"!==t[0].textContent)switch(n[0].textContent){case"error":e=c.Error;break;case"success":e=c.Warning;break;case"info":e=c.Information;break;default:e=c.None}}else d.success("Successfully Uploaded");this.getOwnerComponent().getModel().refresh(!0),this._oBusyDialog.close()},handleCancelPress:function(e){},onSaveDraft:function(){console.log("Save as draft!")}}}));