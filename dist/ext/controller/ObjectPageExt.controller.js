const __attachmentTable="idItemsUploadSet";sap.ui.define(["sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/Core","sap/m/BusyDialog","sap/ui/core/library","sap/m/library","sap/m/UploadCollectionParameter","sap/m/MessageBox"],(function(e,t,a,i,n,s,o,l,r){"use strict";var c=s.MessageType;o.ListMode;return{onInit:function(){this._oBusyDialog=new n,this._MessageManager=i.getMessageManager();const e=new t({items:[]});this.getView().setModel(e,"localModel")},onSelectedChangeType:function(e){let t=e.getParameter("value"),a=this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idChangePanel::Section"),i=this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idCCDChangePanel::Section");"Finance Related"==t?(a.setVisible(!0),i.setVisible(!1)):(a.setVisible(!1),i.setVisible(!0))},onSelectedCountryType:function(e){},beforeSaveExtension:function(){},onExit:function(){},onAfterRendering:function(){var e=this;let t=this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idMaterialInput::Country::Field");sap.ui.getCore().byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idMaterialInput::ChangeType::Field").attachChange(e.onSelectedChangeType,e),t.attachChange(e.onSelectedCountryType,e),this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idChangePanel::Section").setVisible(!1),this.byId("dksh.ymm.mcfupdate.mcfupdate::sap.suite.ui.generic.template.ObjectPage.view.Details::YMM_C_MCF_UPDATE--idCCDChangePanel::Section").setVisible(!1),this.extensionAPI.getTransactionController().attachAfterSave(e.onAfterSave.bind(this))},onAfterSave:function(){var e=this;e.getView().getModel().attachEventOnce("batchRequestCompleted",(function(t){e._checkBatchRequestSuccess(t)?e.onStartUpload():console.error("Save failed, skipping attachment upload")}))},_checkBatchRequestSuccess:function(e){var t=e.getParameter("requests"),a=!0;return t.forEach((function(e){e.success||(a=!1)})),a},onStartUpload:function(){this.getView().getModel("localModel").getProperty("/items").forEach((e=>{this._uploadFileToOData(e)})),e.show("Files are being uploaded.")},onUploadCompleted:function(){var e=this;e.i+=1,e.i===e.iIncompleteItems&&e.byId(__attachmentTable).setBusy(!1)},_uploadFileToOData:function(e){const t=this.getView().getModel();var a=this.getView().getModel().getSecurityToken(),i=this.getView().getBindingContext().getObject().Product;const n=e.content.includes(",")?e.content.split(",")[1]:e.content;t.create("/UploadFileSet",{FileName:e.fileName,MimeType:e.mediaType,Content:n},{headers:{"X-CSRF-Token":a,Slug:encodeURIComponent(e.fileName),"Content-Transfer-Encoding":"base64","Content-Type":e.mediaType,Material:i},success:function(){sap.m.MessageToast.show("File uploaded successfully!")},error:function(e){console.error("Error response:",e.responseText||e.message||e),sap.m.MessageToast.show("File upload failed.")}})},onAfterItemAdded:function(e){const t=e.getParameter("item"),a=this.getView().getModel("localModel"),i=a.getProperty("/items"),n=t.getFileName()||"Unnamed File",s=t.getMediaType()||"application/octet-stream",o=t.getFileObject(),l=new FileReader;l.onload=function(e){const t=e.target.result,o={fileName:n,mediaType:s,content:t};i.push(o),a.setProperty("/items",i)},l.readAsDataURL(o)},onBeforeUploadStarts:function(){},onUploadSelectedButton:function(){this.onStartUpload()},onDownloadSelectedButton:function(){this.byId("UploadSet").getItems().forEach((function(e){e.getListItem().getSelected()&&e.download(!0)}))},onChange:function(t){var a=t.getSource(),i=that.getView().getBindingContext().getObject().Product;this.csrfToken=this.getView().getModel().getSecurityToken();let n=new l({name:"x-csrf-token",value:this.csrfToken}),s=new l({name:"Material",value:i});a.addHeaderParameter(n),a.addHeaderParameter(s),e.show("Event change triggered")},fileSizeExceed:function(){sap.m.MessageToast.show("Maximum permitted file size exceeded. Maximum limit : 20MB")},onFileChange:function(t){let a=t.getSource().oFileUpload.files,i=this;a.length>0?(i.selectedFiles=Array.from(a),e.show(i.selectedFiles.length+" files selected.")):e.show("No files selected.")},handleUploadPress:function(){let e=this.byId("idFileUploader");if(0!==this.selectedFiles.length){var t=this.getView().getBindingContext().getObject().Product;this.csrfToken=this.getView().getModel().getSecurityToken(),this.selectedFiles.forEach(((a,i)=>{e.setValue(a.name);let n=new sap.ui.unified.FileUploaderParameter;n.setName("x-csrf-token"),n.setValue(this.csrfToken);let s=new sap.ui.unified.FileUploaderParameter;s.setName("slug"),s.setValue(e.getValue());let o=new sap.ui.unified.FileUploaderParameter;o.setName("Material"),o.setValue(t),e.checkFileReadable().then((function(){e.addHeaderParameter(n),e.addHeaderParameter(s),e.addHeaderParameter(o),e.upload(),e.destroyHeaderParameters()}),(function(e){r.error("The file cannot be read. It may have changed."),this._oBusyDialog.close()})).then((function(t){e.clear()}))}))}else r.error("Please select files to upload.")},deleteAttachments:function(e){let t=e.getParameter("listItem").getBindingContext("localModel").getPath().split("/")[2],a=this.getView().getModel("localModel");a.getProperty("/attachments").splice(t,1),a.updateBindings()},extractErrorMessage:function(e){return(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("errordetail")},handleUploadComplete:function(e){let t=e.mParameters.responseRaw,a=this.extractErrorMessage(t);if(a.length>0)for(var i=0;i<a.length;i++){let e,t=a[i].getElementsByTagName("message"),n=a[i].getElementsByTagName("severity");if("Exception raised without specific error"!==t[0].textContent)switch(n[0].textContent){case"error":e=c.Error;break;case"success":e=c.Warning;break;case"info":e=c.Information;break;default:e=c.None}}else r.success("Successfully Uploaded");this.getOwnerComponent().getModel().refresh(!0),this._oBusyDialog.close()},handleCancelPress:function(e){},onSaveDraft:function(){console.log("Save as draft!")}}}));